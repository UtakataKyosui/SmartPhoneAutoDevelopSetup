name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      github.repository != 'UtakataKyosui/SmartPhoneAutoDevelopSetup' && (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
        (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
      )
    runs-on: ubuntu-latest
    permissions:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ä»˜ä¸
      contents: write
      # Pull Requestå‘¨ã‚Šã®æ¨©é™ã®ä»˜ä¸
      pull-requests: write
      # Issue ã®ä½œæˆã‚„æ›´æ–°ã®æ¨©é™ã‚’ä»˜ä¸
      issues: write
      # ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡ŒçŠ¶æ…‹ã‚„ãƒ­ã‚°ã®é–²è¦§æ¨©é™
      actions: read
      # commit ã‚„ PR ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä»˜ä¸ã™ã‚‹æ¨©é™ã®ä»˜ä¸
      statuses: write
      # ãƒªãƒã‚¸ãƒˆãƒªã® Projectsï¼ˆæ—§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒ‰ï¼‰ã‚’æ“ä½œã™ã‚‹æ¨©é™
      repository-projects: write
      id-token: write
    env:
      TZ: Asia/Tokyo
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # ğŸ‘ˆ GH_TOKEN ã‚’è¿½åŠ ã—ã¦ .mcp.json ã¨ä¸€è‡´ã•ã›ã‚‹
    steps:
      - uses: ./.github/actions/setup-claude-env
        with:
          fetch-depth: 0

      - name: Load prompt from file
        run: |
          if [ -f docs/prompt.md ]; then
            PROMPT_CONTENT="$(cat docs/prompt.md)"
          else
            PROMPT_CONTENT="# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®æŒ‡ç¤º

          ## Agent Skillsåˆ©ç”¨å¯èƒ½
          ä»¥ä¸‹ã®Agent Skillsã‚’å‚ç…§ã—ã¦ãã ã•ã„

          ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®README.mdã¨CLAUDE.mdã‚’å‚ç…§ã—ã¦é–‹ç™ºã‚’é€²ã‚ã¦ãã ã•ã„ã€‚"
          fi
          {
            echo 'PROMPT<<EOF'
            echo "$PROMPT_CONTENT"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          settings: ".claude/settings.json"
          track_progress: true
          branch_prefix: develop/claude/
          use_sticky_comment: true 
          additional_permissions: |
            actions: read
            contents: write
            pull-requests: write
            issues: write
            actions: read
            statuses: write
            repository-projects: write
            id-token: write
          prompt: | 
            # Claude Code Prompt Template

            ## GitHub ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼:`${{ github.actor }}
            
            ### PR / Issue æƒ…å ±
            - PRç•ªå·: ${{ github.event.issue.number }}
            - PRã‚¿ã‚¤ãƒˆãƒ«: ${{ env.PR_TITLE }}
            - PRæœ¬æ–‡: |
              ${{ env.PR_BODY }}
            - ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡: |
              ${{ github.event.comment.body }}
            
            ### ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±
            - Baseãƒ–ãƒ©ãƒ³ãƒ: ${{ env.PR_BASE }}
            - Headãƒ–ãƒ©ãƒ³ãƒ: ${{ env.PR_HEAD }}
            - Baseãƒ–ãƒ©ãƒ³ãƒ (GitHub): ${{ github.base_ref }}
            - Headãƒ–ãƒ©ãƒ³ãƒ (GitHub): ${{ github.head_ref }}

            ${{ env.PROMPT }}
