name: Claude Code Project Management

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude-project-management:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude spec')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude spec')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude spec')) ||
      (github.event_name == 'issues' && (
        contains(github.event.issue.body, '@claude spec') ||
        contains(github.event.issue.title, '@claude spec')
      ))
    runs-on: ubuntu-latest
    permissions:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ä»˜ä¸
      contents: write
      # Pull Requestå‘¨ã‚Šã®æ¨©é™ã®ä»˜ä¸
      pull-requests: write
      # Issue ã®ä½œæˆã‚„æ›´æ–°ã®æ¨©é™ã‚’ä»˜ä¸
      issues: write
      # ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡ŒçŠ¶æ…‹ã‚„ãƒ­ã‚°ã®é–²è¦§æ¨©é™
      actions: read
      # commit ã‚„ PR ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä»˜ä¸ã™ã‚‹æ¨©é™ã®ä»˜ä¸
      statuses: write
      # ãƒªãƒã‚¸ãƒˆãƒªã® Projectsï¼ˆæ—§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒ‰ï¼‰ã‚’æ“ä½œã™ã‚‹æ¨©é™
      repository-projects: write
      id-token: write
    env:
      TZ: Asia/Tokyo
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # ğŸ‘ˆ GH_TOKEN ã‚’è¿½åŠ ã—ã¦ .mcp.json ã¨ä¸€è‡´ã•ã›ã‚‹
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install uv CLI
        uses: astral-sh/setup-uv@v4

      - name: Setup Git configuration
        run: |
          git config --global user.name "Claude Code PM"
          git config --global user.email "claude-code-pm@anthropic.com"
          git config --global init.defaultBranch main

      - name: Get PR info (only if PR)
        if: ${{ github.event.issue.pull_request }}
        run: |
          if ! gh pr view ${{ github.event.issue.number }} --json number,title,body,baseRefName,headRefName > pr_info.json; then
            echo "Failed to get PR info, creating empty file"
            echo '{}' > pr_info.json
          fi

      - name: Export PR info
        if: ${{ github.event.issue.pull_request }}
        run: |
          if [ -s pr_info.json ] && [ "$(jq -r .title pr_info.json)" != "null" ]; then
            # PR_TITLE
            jq -r .title pr_info.json | tr -d '\r' | while IFS= read -r line; do
              echo "PR_TITLE=$line" >> $GITHUB_ENV
            done

            # PR_BODY
            pr_body=$(jq -r .body pr_info.json | tr -d '\r')
            echo "PR_BODY<<EOF" >> $GITHUB_ENV
            echo "$pr_body" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV

            echo "PR_BASE=$(jq -r .baseRefName pr_info.json | tr -d '\r')" >> $GITHUB_ENV
            echo "PR_HEAD=$(jq -r .headRefName pr_info.json | tr -d '\r')" >> $GITHUB_ENV
          else
            echo "PR_TITLE=" >> $GITHUB_ENV
            echo "PR_BODY=" >> $GITHUB_ENV
            echo "PR_BASE=" >> $GITHUB_ENV
            echo "PR_HEAD=" >> $GITHUB_ENV
          fi

      - name: Load project management prompt from file
        run: |
          if [ -f docs/project-management-prompt.md ]; then
            PROMPT_CONTENT="$(cat docs/project-management-prompt.md)"
          else
            PROMPT_CONTENT="# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ãƒ»ä»•æ§˜å®šç¾©ç”¨ Claude Code

          ## å®Ÿè¡Œå¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰

          ### Spec Kitçµ±åˆã‚³ãƒãƒ³ãƒ‰ï¼ˆä»•æ§˜é§†å‹•é–‹ç™ºï¼‰
          - \\`/spec-kit:specify\\` - è‡ªç„¶è¨€èªã‹ã‚‰ä»•æ§˜ä½œæˆ
          - \\`/spec-kit:plan\\` - ä»•æ§˜ã‹ã‚‰å®Ÿè£…è¨ˆç”»ä½œæˆ
          - \\`/spec-kit:clarify\\` - ä»•æ§˜ã®å¯¾è©±çš„æ˜ç¢ºåŒ–
          - \\`/spec-kit:tasks\\` - TDDæº–æ‹ ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆç”Ÿæˆ
          - \\`/spec-kit:implement\\` - TDDã‚µã‚¤ã‚¯ãƒ«ã§ã®å®Ÿè£…
          - \\`/spec-kit:analyze\\` - æ—¢å­˜ä»•æ§˜ã®åˆ†æ
          - \\`/spec-kit:constitution\\` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ†²æ³•ç®¡ç†

          ### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†
          - \\`/project-management:setup-project\\` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

          ### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
          - \\`/documentation:docs-gen\\` - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ

          ## å®Ÿè¡Œã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

          1. **TDDçµ±åˆé–‹ç™ºãƒ•ãƒ­ãƒ¼**: ä»•æ§˜é§†å‹•é–‹ç™ºã¨ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã‚’çµ„ã¿åˆã‚ã›ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
          2. **Issue Drivené–‹ç™º**: ã™ã¹ã¦ã®é–‹ç™ºã¯Issueã‹ã‚‰é–‹å§‹ã—ã€Issueã«ç´ã¥ã‘ã¦é€²ã‚ã‚‹
          3. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ†²æ³•éµå®ˆ**: é–‹ç™ºåŸå‰‡ã®ä¸€è²«ã—ãŸé©ç”¨ã¨å“è³ªã‚²ãƒ¼ãƒˆã®å®Ÿè¡Œ
          4. **MCPãƒ„ãƒ¼ãƒ«å„ªå…ˆä½¿ç”¨**: é–‹ç™ºä½œæ¥­ã§ã¯åŸºæœ¬çš„ã«MCPãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹

          ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®README.mdã¨CLAUDE.mdã‚’å‚ç…§ã—ã¦ã€ä»•æ§˜å®šç¾©ã€è¨ˆç”»ã€å®Ÿè£…ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚"
          fi
          {
            echo 'PM_PROMPT<<EOF'
            echo "$PROMPT_CONTENT"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Run Claude Code Project Management
        id: claude-pm
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          settings: ".claude/settings.json"
          track_progress: true
          branch_prefix: feature/spec-
          use_sticky_comment: true
          additional_permissions: |
            actions: read
            contents: write
            pull-requests: write
            issues: write
            statuses: write
            repository-projects: write
            id-token: write
          prompt: |
            # Claude Code Project Management Prompt

            ## GitHub ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼: ${{ github.actor }}

            ### PR / Issue æƒ…å ±
            - PRç•ªå·: ${{ github.event.issue.number }}
            - PRã‚¿ã‚¤ãƒˆãƒ«: ${{ env.PR_TITLE }}
            - PRæœ¬æ–‡: |
              ${{ env.PR_BODY }}
            - ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡: |
              ${{ github.event.comment.body }}

            ### ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±
            - Baseãƒ–ãƒ©ãƒ³ãƒ: ${{ env.PR_BASE }}
            - Headãƒ–ãƒ©ãƒ³ãƒ: ${{ env.PR_HEAD }}
            - Baseãƒ–ãƒ©ãƒ³ãƒ (GitHub): ${{ github.base_ref }}
            - Headãƒ–ãƒ©ãƒ³ãƒ (GitHub): ${{ github.head_ref }}

            ${{ env.PM_PROMPT }}

      - name: Post completion status
        if: success()
        run: |
          echo "âœ… Claude Code Project Management completed successfully"

      - name: Post failure status
        if: failure()
        run: |
          echo "âŒ Claude Code Project Management failed"
          exit 1