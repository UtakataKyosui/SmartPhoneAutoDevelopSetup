name: Claude Code Specification

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude-spec:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude plan')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude plan')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude plan')) ||
      (github.event_name == 'issues' && (
        contains(github.event.issue.body, '@claude plan') ||
        contains(github.event.issue.title, '@claude plan')
      ))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      statuses: write
      repository-projects: write
      id-token: write
    env:
      TZ: Asia/Tokyo
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install uv CLI
        uses: astral-sh/setup-uv@v4

      - name: Setup Git configuration
        run: |
          git config --global user.name "Claude Code Spec"
          git config --global user.email "claude-code-spec@anthropic.com"
          git config --global init.defaultBranch main

      - name: Get PR info (only if PR)
        if: ${{ github.event.issue.pull_request }}
        run: |
          if ! gh pr view ${{ github.event.issue.number }} --json number,title,body,baseRefName,headRefName > pr_info.json; then
            echo "Failed to get PR info, creating empty file"
            echo '{}' > pr_info.json
          fi

      - name: Export PR info
        if: ${{ github.event.issue.pull_request }}
        run: |
          if [ -s pr_info.json ] && [ "$(jq -r .title pr_info.json)" != "null" ]; then
            jq -r .title pr_info.json | tr -d '\r' | while IFS= read -r line; do
              echo "PR_TITLE=$line" >> $GITHUB_ENV
            done

            pr_body=$(jq -r .body pr_info.json | tr -d '\r')
            echo "PR_BODY<<EOF" >> $GITHUB_ENV
            echo "$pr_body" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV

            echo "PR_BASE=$(jq -r .baseRefName pr_info.json | tr -d '\r')" >> $GITHUB_ENV
            echo "PR_HEAD=$(jq -r .headRefName pr_info.json | tr -d '\r')" >> $GITHUB_ENV
          else
            echo "PR_TITLE=" >> $GITHUB_ENV
            echo "PR_BODY=" >> $GITHUB_ENV
            echo "PR_BASE=" >> $GITHUB_ENV
            echo "PR_HEAD=" >> $GITHUB_ENV
          fi

      - name: Load specification prompt
        run: |
          if [ -f docs/spec-prompt.md ]; then
            PROMPT_CONTENT="$(cat docs/spec-prompt.md)"
          else
            PROMPT_CONTENT="# 仕様定義・計画・実装支援

          ## Spec Kit統合コマンド利用可能

          以下のスラッシュコマンドを適切に判断して実行してください：

          - \`/spec-kit:specify\` - 自然言語から正式な仕様を作成
          - \`/spec-kit:plan\` - 仕様から具体的な実装計画を生成
          - \`/spec-kit:clarify\` - 仕様の曖昧な点を対話的に明確化
          - \`/spec-kit:tasks\` - 実装計画からTDD準拠のタスクリストを生成
          - \`/spec-kit:implement\` - TDDサイクルに従った機能実装
          - \`/spec-kit:analyze\` - 既存仕様の分析と評価
          - \`/spec-kit:constitution\` - プロジェクト憲法の作成・更新

          ## 実行ガイドライン

          1. **Spec Kit + TDD統合開発フロー**を採用
          2. **Issue Driven開発**でIssueに紐づけて進める
          3. **MCPツール**を優先使用
          4. **プロジェクト憲法**への準拠を確認

          コメント内容から適切な作業を判断し、必要に応じて複数のスラッシュコマンドを組み合わせて実行してください。"
          fi
          {
            echo 'SPEC_PROMPT<<EOF'
            echo "$PROMPT_CONTENT"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Run Claude Code Specification
        id: claude-spec
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          settings: ".claude/settings.json"
          track_progress: true
          branch_prefix: feature/spec-
          use_sticky_comment: true
          additional_permissions: |
            actions: read
            contents: write
            pull-requests: write
            issues: write
            statuses: write
            repository-projects: write
            id-token: write
          prompt: |
            # Claude Code 仕様定義・計画・実装支援

            ## GitHub コンテキスト
            リポジトリ: ${{ github.repository }}
            実行ユーザー: ${{ github.actor }}

            ### PR / Issue 情報
            - PR番号: ${{ github.event.issue.number }}
            - PRタイトル: ${{ env.PR_TITLE }}
            - PR本文: |
              ${{ env.PR_BODY }}
            - コメント本文: |
              ${{ github.event.comment.body }}

            ### ブランチ情報
            - Baseブランチ: ${{ env.PR_BASE }}
            - Headブランチ: ${{ env.PR_HEAD }}
            - Baseブランチ (GitHub): ${{ github.base_ref }}
            - Headブランチ (GitHub): ${{ github.head_ref }}

            ${{ env.SPEC_PROMPT }}

      - name: Post completion status
        if: success()
        run: |
          echo "✅ Claude Code Specification completed successfully"

      - name: Post failure status
        if: failure()
        run: |
          echo "❌ Claude Code Specification failed"
          exit 1